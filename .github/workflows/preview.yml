name: Preview deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: "preview-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check if out directory exists
        id: check-out
        run: |
          if [ -d "./out" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Built site found in ./out directory"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "❌ No built site found in ./out directory"
          fi
      
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './out';
            
            let comment = '## 🔍 Preview Build Check\n\n';
            
            if (fs.existsSync(path)) {
              const files = fs.readdirSync(path);
              comment += `✅ **Built site ready for deployment**\n\n`;
              comment += `📁 Found ${files.length} files in the \`out/\` directory\n\n`;
              comment += `The static site has been built and is ready to be deployed to the main site when this PR is merged.`;
            } else {
              comment += `❌ **No built site found**\n\n`;
              comment += `The \`out/\` directory is missing. Please run \`npm run build\` locally and commit the generated files.`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

